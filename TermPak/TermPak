#!/data/data/com.termux/files/usr/bin/bash

# Diretório onde os apps serão instalados
APPS_DIR="$HOME/termpak-apps"
mkdir -p "$APPS_DIR"

# Função para exibir apps disponíveis
function list_apps() {
    echo "Apps disponíveis no TermHub:"
    ls -1 "$HOME/TermHub/apps" | sed 's/\.deb//;s/\.jar//'
}

# Função para buscar apps
function search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome_do_app>"
        exit 1
    fi
    RESULT=$(ls -1 "$HOME/TermHub/apps" | grep -i "$1" | sed 's/\.deb//;s/\.jar//')
    if [ -z "$RESULT" ]; then
        echo "Aplicativo não existe ou nome errado!"
    else
        echo "$RESULT"
    fi
}

# Função para instalar apps (modo seguro dentro do HOME)
function install_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install <nome_do_app>"
        exit 1
    fi

    APP="$1"
    SRC_FILE="$HOME/TermHub/apps/$APP.deb"

    if [ ! -f "$SRC_FILE" ]; then
        echo "Aplicativo não existe ou nome errado!"
        exit 1
    fi

    TARGET_DIR="$APPS_DIR/$APP"
    mkdir -p "$TARGET_DIR"

    echo "Extraindo $APP.deb para $TARGET_DIR..."
    dpkg-deb -x "$SRC_FILE" "$TARGET_DIR" || { echo "Erro ao extrair o pacote"; exit 1; }

    # Cria atalho no bin
    BIN_PATH=$(find "$TARGET_DIR" -type f -perm -111 | head -n 1)
    if [ -z "$BIN_PATH" ]; then
        echo "Nenhum binário encontrado no pacote. Instalação parcial feita."
    else
        SHORTCUT="$PREFIX/bin/$APP"
        echo "#!/data/data/com.termux/files/usr/bin/bash
$BIN_PATH \$@" > "$SHORTCUT"
        chmod +x "$SHORTCUT"
        echo "Atalho criado: $SHORTCUT"
    fi

    echo "$APP instalado com sucesso!"
}

# Função para remover apps
function remove_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak remove <nome_do_app>"
        exit 1
    fi

    APP="$1"
    APP_DIR="$APPS_DIR/$APP"
    if [ ! -d "$APP_DIR" ]; then
        echo "Aplicativo não está instalado!"
        exit 1
    fi

    rm -rf "$APP_DIR"
    rm -f "$PREFIX/bin/$APP"
    echo "$APP removido!"
}

# Se o usuário apenas digitar TermPak, mostrar versão e comandos
if [ -z "$1" ]; then
    echo "TermPak versão AlphaTest"
    echo "Comandos disponíveis: list, search, install, remove"
    exit 0
fi

# Interpretador de comandos
case "$1" in
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    *)
        echo "Comando inválido! Use: list, search, install, remove"
        ;;
esac
