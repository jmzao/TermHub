#!/data/data/com.termux/files/usr/bin/bash

VERSION="AlphaTest"
APPS_DIR="$HOME/termpak-apps"
mkdir -p "$APPS_DIR"

# Mensagem de ajuda / versão
function show_help() {
    echo "TermPak Version: $VERSION"
    echo "Comandos disponíveis:"
    echo "  list                    - Listar todos os apps disponíveis"
    echo "  search <nome_do_app>    - Buscar um app pelo nome"
    echo "  install <nome_do_app>   - Instalar um app (.deb ou .jar)"
    echo "  remove <nome_do_app>    - Remover um app instalado"
}

# Listar apps disponíveis
function list_apps() {
    echo "Apps disponíveis no TermHub:"
    ls -1 "$HOME/TermHub/apps" | sed 's/\.deb//;s/\.jar//'
}

# Buscar apps
function search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome_do_app>"
        exit 1
    fi
    RESULT=$(ls -1 "$HOME/TermHub/apps" | grep -i "$1" | sed 's/\.deb//;s/\.jar//')
    if [ -z "$RESULT" ]; then
        echo "Aplicativo não existe ou nome errado!"
    else
        echo "$RESULT"
    fi
}

# Instalar apps
function install_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install <nome_do_app>"
        exit 1
    fi

    APP="$1"
    APP_FILE="$HOME/TermHub/apps/$APP"

    # Determinar extensão
    if [ -f "$APP_FILE.deb" ]; then
        EXT="deb"
        APP_FILE="$APP_FILE.deb"
    elif [ -f "$APP_FILE.jar" ]; then
        EXT="jar"
        APP_FILE="$APP_FILE.jar"
    else
        echo "Aplicativo não existe ou nome errado!"
        exit 1
    fi

    # Instalar .deb
    if [ "$EXT" = "deb" ]; then
        echo "Baixando e instalando $APP..."
        dpkg -i "$APP_FILE" || echo "Erro ao instalar $APP"
    fi

    # Instalar .jar
    if [ "$EXT" = "jar" ]; then
        if ! command -v java >/dev/null 2>&1; then
            echo "Erro: Java não encontrado no Termux!"
            echo "Para instalar, use:"
            echo "pkg install openjdk-17"
            exit 1
        fi

        mkdir -p "$APPS_DIR/$APP"
        cp "$APP_FILE" "$APPS_DIR/$APP/$APP.jar"
        echo "$APP instalado com sucesso!"

        # Perguntar sobre atalho
        read -p "Deseja criar um atalho no Termux (comando '$APP')? [s/N]: " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            echo "#!/data/data/com.termux/files/usr/bin/bash
java -jar $APPS_DIR/$APP/$APP.jar" > "$PREFIX/bin/$APP"
            chmod +x "$PREFIX/bin/$APP"
            echo "Atalho criado! Rode '$APP' para abrir."
        fi

        # Procurar imagem
        IMG_FILE="$HOME/TermHub/images/$APP.png"
        if [ -f "$IMG_FILE" ]; then
            echo "Imagem associada encontrada: $IMG_FILE"
        fi
    fi
}

# Remover apps
function remove_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak remove <nome_do_app>"
        exit 1
    fi

    APP="$1"
    APP_FILE="$APPS_DIR/$APP"

    if [ -d "$APP_FILE" ]; then
        rm -rf "$APP_FILE"
        rm -f "$PREFIX/bin/$APP"
        echo "$APP removido com sucesso!"
        exit 0
    fi

    if dpkg -s "$APP" >/dev/null 2>&1; then
        dpkg -r "$APP" || echo "Erro ao remover $APP"
    else
        echo "Aplicativo não existe ou não está instalado!"
    fi
}

# Interpretador de comandos
case "$1" in
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    "")
        show_help
        ;;
    *)
        echo "Comando inválido! Use: list, search, install, remove"
        show_help
        ;;
esac
