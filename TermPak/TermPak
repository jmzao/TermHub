#!/data/data/com.termux/files/usr/bin/bash

TERMPAK_VERSION="AlphaTest v0.1"
APPS_DIR="$HOME/termpak-apps"
REPO_URL="https://raw.githubusercontent.com/jmzao/TermHub/main/apps"

mkdir -p "$APPS_DIR"

show_version() {
    echo "TermPak versão: $TERMPAK_VERSION"
    echo "Comandos disponíveis:"
    echo "  list           -> Listar apps disponíveis"
    echo "  search <app>   -> Buscar app pelo nome"
    echo "  install <app>  -> Instalar app do repositório"
    echo "  install-ref <arquivo.TermPakref> -> Instalar app externo"
    echo "  remove <app>   -> Remover app instalado"
}

list_apps() {
    echo "Apps disponíveis no TermHub:"
    wget -q -O - "$REPO_URL/index.txt"
}

search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome_do_app>"
        exit 1
    fi
    wget -q -O - "$REPO_URL/index.txt" | grep -i "$1"
}

install_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install <nome_do_app>"
        exit 1
    fi
    APP="$1"
    REF_FILE="$APPS_DIR/$APP.TermPakref"

    # Baixar .TermPakref
    echo "Baixando $APP.TermPakref..."
    wget -q -O "$REF_FILE" "$REPO_URL/$APP.TermPakref" || { echo "Erro ao baixar o app!"; exit 1; }

    mkdir -p "$APPS_DIR/$APP"
    unzip -q "$REF_FILE" -d "$APPS_DIR/$APP"
    echo "App '$APP' instalado!"

    # Criar atalho se houver global.png
    if [ -f "$APPS_DIR/$APP/global.png" ]; then
        read -p "Criar atalho no Termux (comando '$APP')? [s/N]: " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            BIN_PATH=$(find "$APPS_DIR/$APP" -type f -perm -u+x | head -n 1)
            [ -n "$BIN_PATH" ] && echo "#!/data/data/com.termux/files/usr/bin/bash
$BIN_PATH" > "$PREFIX/bin/$APP" && chmod +x "$PREFIX/bin/$APP" && echo "Atalho criado!"
        fi
    fi
}

install_ref() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install-ref <caminho_arquivo.TermPakref>"
        exit 1
    fi
    REF_FILE="$1"
    APP_NAME=$(basename "$REF_FILE" .TermPakref)

    mkdir -p "$APPS_DIR/$APP_NAME"
    unzip -q "$REF_FILE" -d "$APPS_DIR/$APP_NAME"
    echo "App '$APP_NAME' instalado via TermPakref!"

    if [ -f "$APPS_DIR/$APP_NAME/global.png" ]; then
        read -p "Criar atalho no Termux (comando '$APP_NAME')? [s/N]: " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            BIN_PATH=$(find "$APPS_DIR/$APP_NAME" -type f -perm -u+x | head -n 1)
            [ -n "$BIN_PATH" ] && echo "#!/data/data/com.termux/files/usr/bin/bash
$BIN_PATH" > "$PREFIX/bin/$APP_NAME" && chmod +x "$PREFIX/bin/$APP_NAME" && echo "Atalho criado!"
        fi
    fi
}

remove_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak remove <nome_do_app>"
        exit 1
    fi
    APP="$1"
    if [ -d "$APPS_DIR/$APP" ]; then
        rm -rf "$APPS_DIR/$APP"
        rm -f "$PREFIX/bin/$APP"
        rm -f "$APPS_DIR/$APP.TermPakref"
        echo "App '$APP' removido!"
    else
        echo "App não está instalado!"
    fi
}

case "$1" in
    ""|version)
        show_version
        ;;
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    install-ref)
        install_ref "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    *)
        echo "Comando inválido! Use: list, search, install, install-ref, remove, version"
        ;;
esac
