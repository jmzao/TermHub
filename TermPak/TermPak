#!/data/data/com.termux/files/usr/bin/bash

# Diretório de instalação local dos apps
APPS_DIR="$HOME/termpak-apps"
REPO="$HOME/TermHub"
mkdir -p "$APPS_DIR"

#############################################
#   FUNÇÃO: listar apps do repositório
#############################################
function list_apps() {
    echo "Apps disponíveis no repositório:"
    ls -1 "$REPO/apps" | sed 's/.deb$//;s/.jar$//'
}

#############################################
#   FUNÇÃO: buscar apps
#############################################
function search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome>"
        exit 1
    fi

    RESULT=$(ls "$REPO/apps" | grep -i "$1")
    if [ -z "$RESULT" ]; then
        echo "Aplicativo não encontrado!"
    else
        echo "$RESULT" | sed 's/.deb$//;s/.jar$//'
    fi
}

#############################################
#   FUNÇÃO: encontrar ícone no repositório
#############################################
function find_icon() {
    local NAME="$1"
    local ICON_PATH="$REPO/images/${NAME}.png"

    if [ -f "$ICON_PATH" ]; then
        echo "$ICON_PATH"
    else
        echo ""   # Sem ícone
    fi
}

#############################################
#   FUNÇÃO: criar atalho .desktop
#############################################
function create_desktop_entry() {
    local NAME="$1"
    local EXEC_CMD="$2"
    local ICON="$3"

    DESK_DIR="$HOME/.local/share/applications"
    mkdir -p "$DESK_DIR"

    FILE="$DESK_DIR/$NAME.desktop"

    echo "[Desktop Entry]
Type=Application
Name=$NAME
Exec=$EXEC_CMD
Icon=$ICON
Terminal=false
Categories=Application;" > "$FILE"

    chmod +x "$FILE"

    echo "Atalho criado em: $FILE"
}

#############################################
#   FUNÇÃO: instalar app
#############################################
function install_app() {
    local APP="$1"

    if [ -z "$APP" ]; then
        echo "Uso: TermPak install <app>"
        exit 1
    fi

    local APP_PATH="$REPO/apps/$APP"

    if [ ! -f "$APP_PATH" ]; then
        echo "Erro: aplicativo não encontrado no repositório!"
        exit 1
    fi

    local EXT="${APP##*.}"
    local NAME="${APP%.*}"
    local ICON=$(find_icon "$NAME")

    case "$EXT" in

        #############################################
        #   INSTALAR .jar
        #############################################
        jar)
            echo "Instalando app Java ($NAME)..."

            mkdir -p "$APPS_DIR/$NAME"
            cp "$APP_PATH" "$APPS_DIR/$NAME/$NAME.jar"

            # Launcher
            LAUNCHER="$PREFIX/bin/$NAME"
            echo "#!/data/data/com.termux/files/usr/bin/bash
java -jar \"$APPS_DIR/$NAME/$NAME.jar\"" > "$LAUNCHER"
            chmod +x "$LAUNCHER"

            echo "$NAME instalado com sucesso!"

            read -p "Criar atalho para $NAME? (s/N): " RESP
            if [[ "$RESP" =~ ^[Ss]$ ]]; then
                create_desktop_entry "$NAME" "$LAUNCHER" "$ICON"
            fi

        ;;

        #############################################
        #   INSTALAR .deb
        #############################################
        deb)
            echo "Instalando pacote Debian ($NAME)..."
            dpkg -i "$APP_PATH" || echo "Erro ao instalar $NAME"

            read -p "Criar atalho para $NAME? (s/N): " RESP
            if [[ "$RESP" =~ ^[Ss]$ ]]; then
                create_desktop_entry "$NAME" "$NAME" "$ICON"
            fi
        ;;

        *)
            echo "Formato não suportado: .$EXT"
            exit 1
        ;;
    esac
}

#############################################
#   FUNÇÃO: remover app
#############################################
function remove_app() {
    local APP="$1"

    if [ -z "$APP" ]; then
        echo "Uso: TermPak remove <app>"
        exit 1
    fi

    local EXT="${APP##*.}"
    local NAME="${APP%.*}"

    # Remover jar
    if [ -d "$APPS_DIR/$NAME" ]; then
        rm -rf "$APPS_DIR/$NAME"
        rm -f "$PREFIX/bin/$NAME"
        rm -f "$HOME/.local/share/applications/$NAME.desktop"
        echo "$NAME removido!"
        exit 0
    fi

    # Remover deb (dpkg)
    dpkg -r "$NAME" && rm -f "$HOME/.local/share/applications/$NAME.desktop"
}

#############################################
#   INTERPRETAÇÃO DOS COMANDOS
#############################################
case "$1" in
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    *)
        echo "Comandos disponíveis: list, search, install, remove"
        ;;
esac
