#!/data/data/com.termux/files/usr/bin/bash

REPO_BASE="https://raw.githubusercontent.com/jmzao/TermHub/main"
APPS_DIR="$HOME/termpak-apps"
INSTALL_PREFIX="$PREFIX"

# Certifica que a pasta local existe
mkdir -p "$APPS_DIR"

# Fun√ß√£o para extrair o .deb manualmente
extract_deb() {
    local debfile="$1"
    local tempdir=$(mktemp -d)

    ar x "$debfile" --output="$tempdir"

    if [ ! -f "$tempdir/data.tar.xz" ] && [ ! -f "$tempdir/data.tar.gz" ]; then
        echo "Pacote .deb corrompido!"
        rm -rf "$tempdir"
        return 1
    fi

    if [ -f "$tempdir/data.tar.xz" ]; then
        tar -xJf "$tempdir/data.tar.xz" -C "$INSTALL_PREFIX"
    else
        tar -xzf "$tempdir/data.tar.gz" -C "$INSTALL_PREFIX"
    fi

    rm -rf "$tempdir"
}

# Mostrar comandos e vers√£o
if [ $# -eq 0 ]; then
    echo "üî• TermPak AlphaTest"
    echo ""
    echo "Comandos dispon√≠veis:"
    echo "  TermPak list"
    echo "  TermPak search nome"
    echo "  TermPak install nome"
    echo "  TermPak remove nome"
    exit 0
fi

cmd="$1"
pkg="$2"

# LISTAR
if [ "$cmd" = "list" ]; then
    curl -s "$REPO_BASE/index.txt"
    exit 0
fi

# PROCURAR
if [ "$cmd" = "search" ]; then
    curl -s "$REPO_BASE/index.txt" | grep -i "$pkg"
    exit 0
fi

# INSTALAR
if [ "$cmd" = "install" ]; then
    if [ -z "$pkg" ]; then
        echo "Use: TermPak install nome"
        exit 1
    fi

    echo "Baixando e instalando $pkg..."

    # Baixa o .deb
    curl -L "$REPO_BASE/termpak-apps/$pkg.deb" -o "$APPS_DIR/$pkg.deb"

    if [ ! -f "$APPS_DIR/$pkg.deb" ]; then
        echo "Erro: pacote n√£o encontrado!"
        exit 1
    fi

    # Extrai o pacote para dentro do PREFIX
    extract_deb "$APPS_DIR/$pkg.deb" || {
        echo "Erro ao instalar $pkg"
        exit 1
    }

    echo "Instalado com sucesso!"

    # √çcone opcional
    if [ -f "$APPS_DIR/$pkg.png" ]; then
        echo "(√≠cone j√° local)"
    else
        curl -L "$REPO_BASE/images/$pkg.png" -o "$APPS_DIR/$pkg.png"
    fi

    exit 0
fi

# REMOVER (n√£o destr√≥i nada do sistema)
if [ "$cmd" = "remove" ]; then
    echo "Remover ainda n√£o implementado."
    exit 0
fi

echo "Comando inv√°lido! Use: list, search, install, remove"
