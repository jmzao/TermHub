#!/data/data/com.termux/files/usr/bin/bash

# Diretório onde os apps serão instalados
APPS_DIR="$HOME/termpak-apps"
mkdir -p "$APPS_DIR"

# Função para listar apps disponíveis
function list_apps() {
    echo "Apps disponíveis no TermHub:"
    ls -1 "$HOME/TermHub/apps" | sed 's/\.deb//;s/\.jar//'
}

# Função para buscar apps
function search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome_do_app>"
        exit 1
    fi
    RESULT=$(ls -1 "$HOME/TermHub/apps" | grep -i "$1" | sed 's/\.deb//;s/\.jar//')
    if [ -z "$RESULT" ]; then
        echo "Aplicativo não existe ou nome errado!"
    else
        echo "$RESULT"
    fi
}

# Função para instalar .deb
function install_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install <nome_do_app>"
        exit 1
    fi

    APP="$1"
    APP_FILE="$HOME/TermHub/apps/$APP.deb"

    if [ ! -f "$APP_FILE" ]; then
        echo "Aplicativo não existe ou nome errado!"
        exit 1
    fi

    echo "Baixando e instalando $APP..."
    cp "$APP_FILE" "$APPS_DIR/"
    dpkg -i "$APPS_DIR/$APP.deb" || echo "Erro ao instalar $APP"

    # Pergunta sobre atalho
    read -p "Deseja criar um atalho no Termux (comando '$APP')? [s/N]: " RESP
    if [[ "$RESP" =~ ^[Ss]$ ]]; then
        echo "#!/data/data/com.termux/files/usr/bin/bash
dpkg -l | grep -q $APP && echo '$APP já instalado' || echo 'App não instalado'" > "$PREFIX/bin/$APP"
        chmod +x "$PREFIX/bin/$APP"
        echo "Atalho criado! Agora você pode rodar '$APP'."
    fi
}

# Função para instalar .jar
function install_jar() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak jar install <nome_do_app>"
        exit 1
    fi

    APP="$1"
    JAR_FILE="$HOME/TermHub/apps/$APP.jar"

    if [ ! -f "$JAR_FILE" ]; then
        echo "Aplicativo não existe ou nome errado!"
        exit 1
    fi

    mkdir -p "$APPS_DIR/$APP"
    cp "$JAR_FILE" "$APPS_DIR/$APP/"
    echo "$APP instalado com sucesso!"

    # Pergunta sobre atalho
    read -p "Deseja criar um atalho no Termux (comando '$APP')? [s/N]: " RESP
    if [[ "$RESP" =~ ^[Ss]$ ]]; then
        echo "#!/data/data/com.termux/files/usr/bin/bash
java -jar $APPS_DIR/$APP/$APP.jar" > "$PREFIX/bin/$APP"
        chmod +x "$PREFIX/bin/$APP"
        echo "Atalho criado! Agora você pode rodar o app com '$APP'."
    fi
}

# Função para remover apps
function remove_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak remove <nome_do_app>"
        exit 1
    fi

    APP="$1"
    # Para .jar
    if [ -d "$APPS_DIR/$APP" ]; then
        rm -rf "$APPS_DIR/$APP"
        rm -f "$PREFIX/bin/$APP"
        echo "$APP removido!"
        exit 0
    fi

    # Para .deb
    APP_FILE="$APPS_DIR/$APP.deb"
    if [ -f "$APP_FILE" ]; then
        dpkg -r "$APP" || echo "Erro ao remover $APP"
        rm -f "$APP_FILE"
        rm -f "$PREFIX/bin/$APP"
        echo "$APP removido!"
        exit 0
    fi

    echo "Aplicativo não existe ou não está instalado!"
}

# Interpretador de comandos
case "$1" in
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    jar)
        if [ "$2" = "install" ]; then
            install_jar "$3"
        else
            echo "Uso: TermPak jar install <nome_do_app>"
        fi
        ;;
    *)
        echo "Comando inválido! Use: list, search, install, remove, jar"
        ;;
esac
