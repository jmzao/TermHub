#!/data/data/com.termux/files/usr/bin/bash

# Diretório onde os apps serão instalados
APPS_DIR="$HOME/termpak-apps"
mkdir -p "$APPS_DIR"

# Função para exibir apps disponíveis
function list_apps() {
    echo "Apps disponíveis no TermHub:"
    ls -1 "$HOME/TermHub/apps" | sed 's/\.deb//;s/\.jar//'
}

# Função para buscar apps
function search_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak search <nome_do_app>"
        exit 1
    fi
    RESULT=$(ls -1 "$HOME/TermHub/apps" | grep -i "$1" | sed 's/\.deb//;s/\.jar//')
    if [ -z "$RESULT" ]; then
        echo "Aplicativo não existe ou nome errado!"
    else
        echo "$RESULT"
    fi
}

# Função para instalar apps (.deb ou .jar)
function install_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak install <nome_do_app>"
        exit 1
    fi

    APP="$1"

    # Verifica se é TermHub (arquivo .jar)
    if [ "$APP" = "TermHub" ]; then
        if ! command -v java >/dev/null 2>&1; then
            echo "Erro: Java não encontrado!"
            echo "Instale com: pkg install openjdk-17"
            exit 1
        fi

        mkdir -p "$APPS_DIR/$APP"
        URL="https://raw.githubusercontent.com/jmzao/TermHub/main/TermHubApp/TermHub.jar"
        echo "Baixando TermHub..."
        wget -q "$URL" -O "$APPS_DIR/$APP/TermHub.jar"
        echo "TermHub instalado com sucesso!"

        # Pergunta sobre atalho
        read -p "Deseja criar atalho TermHub? [s/N]: " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            echo "#!/data/data/com.termux/files/usr/bin/bash
java -jar $APPS_DIR/$APP/TermHub.jar" > "$PREFIX/bin/termhub"
            chmod +x "$PREFIX/bin/termhub"
            echo "Atalho criado! Rode 'termhub' para abrir a loja."
        fi

        # Pergunta sobre ícone
        read -p "Deseja baixar ícone na área de trabalho? [s/N]: " ICON
        if [[ "$ICON" =~ ^[Ss]$ ]]; then
            IMG_URL="https://raw.githubusercontent.com/jmzao/TermHub/main/images/TermHub.png"
            mkdir -p "$APPS_DIR/$APP/images"
            wget -q "$IMG_URL" -O "$APPS_DIR/$APP/images/TermHub.png"
            echo "Ícone baixado em '$APPS_DIR/$APP/images/TermHub.png'"
        fi
        exit 0
    fi

    # Para outros apps (.deb)
    APP_FILE="$HOME/TermHub/apps/$APP.deb"
    if [ ! -f "$APP_FILE" ]; then
        echo "Aplicativo não existe ou nome errado!"
        exit 1
    fi
    echo "Instalando $APP..."
    dpkg -i "$APP_FILE" || echo "Erro ao instalar $APP"
}

# Função para remover apps
function remove_app() {
    if [ -z "$1" ]; then
        echo "Uso: TermPak remove <nome_do_app>"
        exit 1
    fi

    APP="$1"

    if [ "$APP" = "TermHub" ]; then
        rm -rf "$APPS_DIR/TermHub"
        rm -f "$PREFIX/bin/termhub"
        echo "TermHub removido!"
        exit 0
    fi

    APP_FILE="$HOME/TermHub/apps/$APP.deb"
    if [ ! -f "$APP_FILE" ]; then
        echo "Aplicativo não existe ou não está instalado!"
        exit 1
    fi
    echo "Removendo $APP..."
    dpkg -r "$APP" || echo "Erro ao remover $APP"
}

# Interpretador de comandos
case "$1" in
    "" )
        echo "TermPak versão AlphaTest"
        echo "Comandos disponíveis:"
        echo "  list                - Lista todos os apps disponíveis"
        echo "  search <app>        - Busca um app pelo nome"
        echo "  install <app>       - Instala um app (.deb ou TermHub.jar)"
        echo "  remove <app>        - Remove um app instalado"
        ;;
    list)
        list_apps
        ;;
    search)
        search_app "$2"
        ;;
    install)
        install_app "$2"
        ;;
    remove)
        remove_app "$2"
        ;;
    TermHub)
        install_app "TermHub"
        ;;
    *)
        echo "Comando inválido! Use: list, search, install, remove"
        ;;
esac
