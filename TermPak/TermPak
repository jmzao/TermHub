#!/data/data/com.termux/files/usr/bin/bash

set -e

TERMPAK_HOME="$HOME/.termpak-installed"
APPS_DIR="$PREFIX/usr/local/bin"
DESKTOP_DIR="$HOME/.local/share/applications"

mkdir -p "$TERMPAK_HOME"
mkdir -p "$APPS_DIR"
mkdir -p "$DESKTOP_DIR"

show_help() {
    echo ""
    echo "TermPak AlphaTest"
    echo "Comandos disponíveis:"
    echo "  TermPak install <app>        Instala pacote oficial do repo"
    echo "  TermPak install-ref <path>   Instala arquivo .TermPakref"
    echo "  TermPak remove <app>         Remove app instalado"
    echo "  TermPak list                 Lista apps instalados"
    echo "  TermPak version              Mostra a versão"
    echo ""
}

# TermPak sem argumentos
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

cmd="$1"

###############################################
# LIST
###############################################
if [ "$cmd" = "list" ]; then
    echo "Apps instalados:"
    ls "$TERMPAK_HOME"
    exit 0
fi

###############################################
# VERSION
###############################################
if [ "$cmd" = "version" ]; then
    echo "TermPak versão AlphaTest"
    exit 0
fi

###############################################
# REMOVE
###############################################
if [ "$cmd" = "remove" ]; then
    app="$2"
    if [ ! -d "$TERMPAK_HOME/$app" ]; then
        echo "App não está instalado."
        exit 1
    fi

    rm -rf "$TERMPAK_HOME/$app"
    rm -f "$APPS_DIR/$app"
    rm -f "$DESKTOP_DIR/$app.desktop"

    echo "Removido: $app"
    exit 0
fi

###############################################
# INSTALL REF (arquivo .TermPakref)
###############################################
if [ "$cmd" = "install-ref" ]; then
    pkg_path="$2"

    if [ ! -f "$pkg_path" ]; then
        echo "Arquivo não encontrado: $pkg_path"
        exit 1
    fi

    app="$(basename "$pkg_path" .TermPakref)"

    install_dir="$TERMPAK_HOME/$app"
    mkdir -p "$install_dir"

    echo "Instalando pacote TermPakref: $app"

    unzip -o "$pkg_path" -d "$install_dir" >/dev/null 2>&1

    # binários
    if [ ! -d "$install_dir/app" ]; then
        echo "Pacote inválido: falta diretório app/"
        exit 1
    fi

    for b in "$install_dir/app/"*; do
        name=$(basename "$b")
        cp "$b" "$APPS_DIR/$name"
        chmod +x "$APPS_DIR/$name"
    done

    # ícone
    if [ -f "$install_dir/global.png" ]; then
        cp "$install_dir/global.png" "$install_dir/icon.png"
    fi

    # cria .desktop automaticamente usando o primeiro binário
    first_bin=$(ls "$install_dir/app" | head -n 1)

    cat > "$DESKTOP_DIR/$app.desktop" <<EOF
[Desktop Entry]
Name=$app
Exec=$first_bin
Icon=$install_dir/icon.png
Type=Application
Terminal=true
EOF

    echo "Instalado com sucesso: $app"
    exit 0
fi

###############################################
# INSTALL (REPOSITÓRIO FUTURO)
###############################################
if [ "$cmd" = "install" ]; then
    echo "Instalação via repositório ainda não implementada."
    exit 0
fi

###############################################
# INVALIDO
###############################################
echo "Comando inválido!"
show_help
exit 1
