#!/data/data/com.termux/files/usr/bin/bash

APPS_DIR="$HOME/termpak-apps"
mkdir -p "$APPS_DIR"

function find_icon() {
    local NAME="$1"

    # Ícones ficam em: ~/TermHub/images/NOME.png
    if [ -f "$HOME/TermHub/images/${NAME}.png" ]; then
        echo "$HOME/TermHub/images/${NAME}.png"
    else
        echo ""
    fi
}

function create_desktop_entry() {
    local NAME="$1"
    local EXEC="$2"
    local ICON="$3"

    DESKTOP_FILE="$HOME/.local/share/applications/${NAME}.desktop"
    mkdir -p "$HOME/.local/share/applications"

    echo "[Desktop Entry]
Name=$NAME
Exec=$EXEC
Type=Application
Icon=$ICON
Terminal=false" > "$DESKTOP_FILE"

    echo "Atalho criado em $DESKTOP_FILE"
}

function install_app() {
    local APP="$1"
    local APP_PATH="$HOME/TermHub/apps/$APP"

    if [ ! -f "$APP_PATH" ]; then
        echo "Erro: app não existe."
        exit 1
    fi

    EXT="${APP##*.}"
    NAME="${APP%.*}"

    ICON=$(find_icon "$NAME")

    # INSTALAR .JAR
    if [ "$EXT" = "jar" ]; then
        echo "Instalando app Java..."

        mkdir -p "$APPS_DIR/$NAME"
        cp "$APP_PATH" "$APPS_DIR/$NAME/$NAME.jar"

        LAUNCHER="$PREFIX/bin/$NAME"
        echo "#!/data/data/com.termux/files/usr/bin/bash
java -jar \"$APPS_DIR/$NAME/$NAME.jar\"" > "$LAUNCHER"
        chmod +x "$LAUNCHER"

        echo "$NAME instalado com sucesso!"

        read -p "Criar atalho na área de trabalho? (s/N): " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            create_desktop_entry "$NAME" "$LAUNCHER" "$ICON"
        fi

        exit 0
    fi

    # INSTALAR .DEB
    if [ "$EXT" = "deb" ]; then
        echo "Instalando pacote Debian..."
        dpkg -i "$APP_PATH" || echo "Erro ao instalar $NAME"

        read -p "Criar atalho na área de trabalho? (s/N): " RESP
        if [[ "$RESP" =~ ^[Ss]$ ]]; then
            create_desktop_entry "$NAME" "$NAME" "$ICON"
        fi

        exit 0
    fi

    echo "Formato não suportado: .$EXT"
}

function list_apps() {
    echo "Apps disponíveis:"
    ls -1 "$HOME/TermHub/apps"
}

function search_app() {
    grep -i "$1" "$HOME/TermHub/apps"
}

case "$1" in
    list)
        list_apps ;;
    install)
        install_app "$2" ;;
    search)
        search_app "$2" ;;
    *)
        echo "Use: list, install <app>, search <nome>"
        ;;
esac
